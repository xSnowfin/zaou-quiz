<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>蔵王ジャンプ台フェスティバル 謎解きクイズラリー！</title>
  <style>
    body {
      font-family: 'Comic Sans MS', 'Arial', sans-serif;
      text-align: center;
      padding: 20px;
      background: #f0f8ff;
    }
    .hidden { display: none; }
    .quiz-container {
      margin: 20px auto;
      padding: 20px;
      max-width: 500px;
      border: 2px solid #333;
      border-radius: 15px;
      background: #fff;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #87ceeb;
    }
    button:disabled { background: #ccc; cursor: not-allowed; }

    /* キーワード表示（最終ページ用） */
    #collected-keywords {
      margin-top: 20px;
      font-size: 1.4em;
      font-weight: bold;
      color: #228b22;
    }
    .keyword {
      display: inline-block;
      margin: 5px;
      padding: 8px 12px;
      background: #e0ffe0;
      border-radius: 8px;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
    }
    .char {
      display: inline-block;
      margin: 0 3px;
      font-size: 1.5em;
    }

    /* 画面下部のキーワードボックス */
    #collected-keywords-bottom {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
      color: #228b22;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #e0ffe0;
      padding: 10px;
      border-radius: 12px;
      margin-left: auto;
      margin-right: auto;
      max-width: 90%;
      box-sizing: border-box;
    }
    #collected-keywords-bottom .label {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 6px;
    }
    #collected-keywords-bottom .keyword {
      margin: 0;
      background: transparent;
      padding: 0;
      box-shadow: none;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    #collected-keywords-bottom .char {
      margin: 0 4px;
      font-size: 1.4em;
      display: inline-block;
    }

    /* 正解・不正解メッセージ */
    #keyword-message {
      margin-top: 15px;
      font-size: 1.3em;
      font-weight: bold;
      display: none;
      padding: 10px;
      border-radius: 10px;
      animation: fadeIn 0.6s ease-in-out;
      text-align: center;
    }
    #keyword-message.success {
      color: green;
      background: #e0ffe0;
    }
    #keyword-message.fail {
      color: red;
      background: #ffe0e0;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>蔵王ジャンプ台フェスティバル 謎解きクイズラリー！</h1>

  <div id="content"></div>
  <div id="collected-keywords-bottom"></div>

  <audio id="correct-sound" src="sounds/correct.mp3"></audio>
  <audio id="wrong-sound" src="sounds/wrong.mp3"></audio>

  <script>
    const quizzes = {
      q1: { question: "日本で一番高い山は？", options: ["富士山", "北岳", "穂高岳"], correct: 0, keyword: "ツ" },
      q2: { question: "3.14で有名な数学定数は？", options: ["オイラー数", "円周率", "黄金比"], correct: 1, keyword: "リ" },
      q3: { question: "犬は英語で？", options: ["Dog", "Cat", "Bird"], correct: 0, keyword: "ー" },
      q4: { question: "信号で進めの色は？", options: ["赤", "青", "黄"], correct: 1, keyword: "ズ" },
      q5: { question: "水の化学式は？", options: ["H2O", "CO2", "O2"], correct: 0, keyword: "！" },
    };

    function getCollectedKeywordsArray() {
      let arr = [];
      Object.keys(quizzes).forEach(id => {
        const k = localStorage.getItem(`quiz${id}_cleared`);
        if (k) arr.push(k);
      });
      return arr;
    }

    function renderCollectedKeywordsHTML() {
      const arr = getCollectedKeywordsArray();
      if (arr.length === 0) return '<p>まだキーワードは集まっていません。</p>';
      return arr.map(k => `<span class="keyword">${k.split('').map(ch => `<span class="char">${ch}</span>`).join('')}</span>`).join('');
    }

    function renderCollectedKeywordsHTML_forBottom() {
      const arr = getCollectedKeywordsArray();
      if (arr.length === 0) return '';
      return `
        <div class="label">今まで解いた問題のキーワード</div>
        <div class="keyword">
          ${arr.map(k => k.split('').map(ch => `<span class="char">${ch}</span>`).join('')).join('')}
        </div>
      `;
    }

    function renderTopPage() {
      let html = `<div class="quiz-container">
        <h2>挑戦するクイズを選んでね！</h2>`;
      Object.keys(quizzes).forEach(id => {
        html += `<p><a href="#${id}">問題 ${id.replace('q','')}</a></p>`;
      });
      html += `</div>`;

      const arr = getCollectedKeywordsArray();
      if (arr.length === Object.keys(quizzes).length) {
        html += `<div id="collected-keywords"><h3>おめでとう！全てのキーワードを集めたよ！</h3>${renderCollectedKeywordsHTML()}</div>`;
      }
      document.getElementById("content").innerHTML = html;
    }

    function renderQuizPage(id) {
      const quiz = quizzes[id];
      if (!quiz) return renderTopPage();

      let html = `<div class="quiz-container">
        <h2>${quiz.question}</h2>
        <div class="options">`;
      quiz.options.forEach((opt,i) => {
        html += `<button onclick="checkAnswer(${i}, '${id}')">${opt}</button>`;
      });
      html += `</div>
        <div id="keyword-message"></div>
        <p><a href="#">← クイズ選択に戻る</a></p>
      </div>`;

      document.getElementById("content").innerHTML = html;
    }

    function checkAnswer(selected, id) {
      const quiz = quizzes[id];
      const buttons = document.querySelectorAll(".options button");
      const msgBox = document.getElementById("keyword-message");

      if (selected === quiz.correct) {
        // ✅ 正解
        msgBox.innerHTML = `⭕ 正解！キーワードは <span style="color:red;">『${quiz.keyword}』</span> です`;
        msgBox.className = "success";
        msgBox.style.display = "block";

        localStorage.setItem(`quiz${id}_cleared`, quiz.keyword);
        playSound("correct-sound");
        confetti();
        updateCollectedKeywordsBottom();
      } else {
        // ❌ 不正解
        msgBox.innerHTML = "❌ 残念！5秒後にもう一度挑戦しよう！";
        msgBox.className = "fail";
        msgBox.style.display = "block";

        playSound("wrong-sound");

        buttons.forEach(b => b.disabled = true);
        let countdown = 5;
        const interval = setInterval(() => {
          countdown--;
          msgBox.innerHTML = `❌ 残念！ ${countdown}秒後にもう一度挑戦できます`;
          if (countdown <= 0) {
            clearInterval(interval);
            msgBox.style.display = "none";
            buttons.forEach(b => b.disabled = false);
          }
        }, 1000);
      }
    }

    function updateCollectedKeywordsBottom(forceShow) {
      const bottom = document.getElementById("collected-keywords-bottom");
      bottom.innerHTML = renderCollectedKeywordsHTML_forBottom();
      if (bottom.innerHTML) bottom.style.display = "block";
      else bottom.style.display = "none";
    }

    function playSound(id) {
      const el = document.getElementById(id);
      if (el) { el.currentTime = 0; el.play(); }
    }

    function renderPage() {
      const qid = location.hash.replace('#','');
      if (qid && quizzes[qid]) renderQuizPage(qid);
      else renderTopPage();

      if (qid) {
        updateCollectedKeywordsBottom(true);
      } else {
        let keywords = getCollectedKeywordsArray();
        if (keywords.length === Object.keys(quizzes).length) {
          updateCollectedKeywordsBottom(false);
        } else {
          updateCollectedKeywordsBottom(true);
        }
      }
    }

    window.addEventListener("hashchange", renderPage);
    window.addEventListener("load", renderPage);

    // 簡易紙吹雪エフェクト
    function confetti() {
      const duration = 1000;
      const end = Date.now() + duration;
      (function frame() {
        const colors = ['#bb0000', '#ffffff', '#0000bb'];
        const particle = document.createElement('div');
        particle.style.position = 'fixed';
        particle.style.width = '8px';
        particle.style.height = '8px';
        particle.style.background = colors[Math.floor(Math.random()*colors.length)];
        particle.style.top = '-10px';
        particle.style.left = Math.random() * window.innerWidth + 'px';
        particle.style.opacity = 1;
        particle.style.pointerEvents = 'none';
        document.body.appendChild(particle);

        const fall = setInterval(() => {
          particle.style.top = (parseFloat(particle.style.top)+5) + 'px';
          if (parseFloat(particle.style.top) > window.innerHeight) {
            clearInterval(fall);
            document.body.removeChild(particle);
          }
        }, 16);

        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }
  </script>
</body>
</html>
